<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://ankeri.github.io/pytest-respect/api-utils/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Utilities - pytest-respect</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Utilities";
        var mkdocs_page_input_path = "api-utils.md";
        var mkdocs_page_url = "/pytest-respect/api-utils/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> pytest-respect
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHANGES/">Changes</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../api-resources/">Resources</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Utilities</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#pytest_respect.utils">utils</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pytest_respect.utils.AbortJsonPrep">AbortJsonPrep</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pytest_respect.utils.add_json_prepper">add_json_prepper</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pytest_respect.utils.prepare_for_json_encode">prepare_for_json_encode</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../api-ext/">Extensions</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">pytest-respect</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">API Reference</li>
      <li class="breadcrumb-item active">Utilities</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pytest_respectutils"><code>pytest_respect.utils</code></h1>


<div class="doc doc-object doc-module">



<a id="pytest_respect.utils"></a>
    <div class="doc doc-contents first">

        <p>Utilities used by the <code>resources</code> fixture. Most notably holds the registry of "perppers" which prepare values of
different types to be converted to JSON.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="pytest_respect.utils.AbortJsonPrep" class="doc doc-heading">
            <code>AbortJsonPrep</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="Exception">Exception</span></code></p>



        <p>Raised by a JSON prepper to indicate that even though the argument is of the expected type, it should not be
handled by this prepper and any other ones should be given the oportuinty to handle it.</p>







              <details class="quote">
                <summary>Source code in <code>src/pytest_respect/utils.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AbortJsonPrep</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>  <span class="c1"># noqa: N818</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised by a JSON prepper to indicate that even though the argument is of the expected type, it should not be</span>
<span class="sd">    handled by this prepper and any other ones should be given the oportuinty to handle it.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>


</div>


<div class="doc doc-object doc-function">


<h2 id="pytest_respect.utils.add_json_prepper" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_json_prepper</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">prepper</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Register a global JSON prepper for a given type, including sub-classes.</p>
<p>The prepper can return a few kinds of values:
- Simple value: encoded as-is and must be JSON serializable.
- Dict: encoded recursively but must have keys that are supported by the json_encoder use, which is usually str.
- Collection: list, tuple, set, etc will be recursively encoded as a list.</p>
<p>It can also raise AbortJsonPrep to skip this prepper and continue trying others.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pytest_respect/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_json_prepper</span><span class="p">(</span><span class="n">type_</span><span class="p">:</span> <span class="nb">type</span> <span class="o">|</span> <span class="n">UnionType</span><span class="p">,</span> <span class="n">prepper</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a global JSON prepper for a given type, including sub-classes.</span>

<span class="sd">    The prepper can return a few kinds of values:</span>
<span class="sd">    - Simple value: encoded as-is and must be JSON serializable.</span>
<span class="sd">    - Dict: encoded recursively but must have keys that are supported by the json_encoder use, which is usually str.</span>
<span class="sd">    - Collection: list, tuple, set, etc will be recursively encoded as a list.</span>

<span class="sd">    It can also raise AbortJsonPrep to skip this prepper and continue trying others.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_JSON_PREPPERS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">type_</span><span class="p">,</span> <span class="n">prepper</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pytest_respect.utils.prepare_for_json_encode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prepare_for_json_encode</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_negative_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_preppers</span><span class="o">=</span><span class="nb">tuple</span><span class="p">())</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Copy a structure of lists, tuples, dicts, pydantic models and numpy values into a parallel structure of dicts and
lists, trying to make them JSON encodable.</p>
<p>The encoding is specifically intended for writing expectation files, so it doesn't need to be reversible, and if
data or precision is lost in a way that is not acceptable, then the user has the opportunity to register a custom
prepper for that type.</p>
<p>This library installs preppers for pydantic models and numpy arrays if those libraries are installed.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>value</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The value to prepare for JSON encoding</p>
              </div>
            </li>
            <li>
              <b><code>ndigits</code></b>
                  (<code><span title="int">int</span> | None</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The number of digits to round floats to, or None to omit rounding</p>
              </div>
            </li>
            <li>
              <b><code>allow_negative_zero</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>If False, convert negative zero to plain zero in output</p>
              </div>
            </li>
            <li>
              <b><code>extra_preppers</code></b>
                  (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="tuple">tuple</span>[<span title="type">type</span> | <span title="types.UnionType">UnionType</span>, <span title="collections.abc.Callable">Callable</span>[[<span title="typing.Any">Any</span>], <span title="typing.Any">Any</span>]]]</code>, default:
                      <code><span title="tuple">tuple</span>()</code>
)
              –
              <div class="doc-md-description">
                <p>Additional preppers to apply before the registered ones.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pytest_respect/utils.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">prepare_for_json_encode</span><span class="p">(</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">ndigits</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">allow_negative_zero</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_preppers</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span> <span class="o">|</span> <span class="n">UnionType</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy a structure of lists, tuples, dicts, pydantic models and numpy values into a parallel structure of dicts and</span>
<span class="sd">    lists, trying to make them JSON encodable.</span>

<span class="sd">    The encoding is specifically intended for writing expectation files, so it doesn&#39;t need to be reversible, and if</span>
<span class="sd">    data or precision is lost in a way that is not acceptable, then the user has the opportunity to register a custom</span>
<span class="sd">    prepper for that type.</span>

<span class="sd">    This library installs preppers for pydantic models and numpy arrays if those libraries are installed.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The value to prepare for JSON encoding</span>
<span class="sd">        ndigits: The number of digits to round floats to, or None to omit rounding</span>
<span class="sd">        allow_negative_zero: If False, convert negative zero to plain zero in output</span>
<span class="sd">        extra_preppers: Additional preppers to apply before the registered ones.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Apply the configured preppers</span>
    <span class="k">for</span> <span class="n">type_</span><span class="p">,</span> <span class="n">prepper</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">extra_preppers</span><span class="p">,</span> <span class="n">_JSON_PREPPERS</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">prepper</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="n">AbortJsonPrep</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># Apply rounding of floats values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ndigits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ndigits</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_negative_zero</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">+=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Return other JSON encodable values directly</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">recurse</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">prepare_for_json_encode</span><span class="p">,</span>
        <span class="n">ndigits</span><span class="o">=</span><span class="n">ndigits</span><span class="p">,</span>
        <span class="n">allow_negative_zero</span><span class="o">=</span><span class="n">allow_negative_zero</span><span class="p">,</span>
        <span class="n">extra_preppers</span><span class="o">=</span><span class="n">extra_preppers</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Recurse into dicts and collections</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">recurse</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">recurse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Collection</span><span class="p">):</span>
        <span class="c1"># Collections other than strings are encoded to lists</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">recurse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="c1"># Convert anything else to a string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../api-resources/" class="btn btn-neutral float-left" title="Resources"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../api-ext/" class="btn btn-neutral float-right" title="Extensions">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../api-resources/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../api-ext/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
